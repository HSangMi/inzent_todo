<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project">
	<insert id="insertProject" parameterType="projectvo">
		<![CDATA[
			insert into tb_project
			( id, title, description, use_public, start_date, end_date, img_no, manager )
			values
			( #{id}, #{title}, #{description}, #{usePublic}, #{startDate}, #{endDate}, #{imgNo}, #{manager})
		]]>
	</insert>
	<select id="selectProjectList" resultType="projectcarddto">
	<![CDATA[
	select tp.*, tu.id as user_id , tu.img_code ,(SELECT COUNT(tm2.member_no) FROM tb_member tm2 WHERE tm2.project_id = tp.id) as memberCnt
	from tb_project tp, tb_member tm , tb_user tu 
	where tp.manager = tm.member_no and tm.user_id = tu.id and tp.use_public = true
	union
	select tp.*, tu.id , tu.img_code ,(SELECT COUNT(tm2.member_no) FROM tb_member tm2 WHERE tm2.project_id = tp.id) as memberCnt
	from tb_project tp, tb_member tm , tb_user tu 
	where tp.manager = tm.member_no and tm.user_id = #{userId} and tu.id = #{userId} and tp.use_public = false;
	select * from tb_project
	]]>
	</select>
	<select id="selectProject" resultType="projectvo">
	<![CDATA[
		select * from tb_project where id = #{pid}
	]]>
	</select>
	<insert id="insertTaskSuper" parameterType="taskdto">
		<![CDATA[
			insert into tb_task_super
			( task_id, title, description, use_public, start_date, end_date, sort_no, state, labels, member_no, project_id )
			values
			( #{taskId}, #{title}, #{description}, #{usePublic}, #{startDate}, #{endDate}, #{sortNo}, #{state}, #{labels}, #{memberNo}, #{projectId})
		]]>
	</insert>
	<insert id="insertTaskSub" parameterType="taskdto">
		<![CDATA[
			insert into tb_task_sub
			( task_id, title, description, use_public, start_date, end_date, sort_no, member_no, labels, task_super_id, state )
			values
			( #{taskId}, #{title}, #{description}, #{usePublic}, #{startDate}, #{endDate}, #{sortNo}, #{memberNo}, #{labels}, #{taskSuperId}, #{state})
		]]>
	</insert>
	<select id="selectTaskSuperList" parameterType="map" resultType="supertaskvo">
	<![CDATA[
		select ttsp.*,
		(SELECT COUNT(tf.file_no) FROM tb_file tf WHERE tf.task_id = ttsp.task_id) as fileCnt,
		(SELECT COUNT(tc.comment_no) FROM tb_comment tc WHERE tc.task_id = ttsp.task_id) as CommentCnt
		from tb_task_super ttsp
		where ttsp.project_id = #{pid} and ttsp.use_public = true
		UNION
		select tts.*,
		(SELECT COUNT(tf.file_no) FROM tb_file tf WHERE tf.task_id = tts.task_id) as fileCnt,
		(SELECT COUNT(tc.comment_no) FROM tb_comment tc WHERE tc.task_id = tts.task_id) as CommentCnt
		from tb_task_super tts
		where tts.project_id = #{pid} 
		and use_public = false 
		and tts.member_no = #{memNo}
	]]>
	</select>
	<select id="selectTaskSubList" parameterType="map" resultType="taskdto">
	<![CDATA[
		select tts.*,
		(SELECT COUNT(tf.file_no) FROM tb_file tf WHERE tf.task_id = tts.task_id) as fileCnt,
		(SELECT COUNT(tc.comment_no) FROM tb_comment tc WHERE tc.task_id = tts.task_id) as CommentCnt,
		(SELECT json_agg(ttm.member_no) as manager_name FROM tb_task_manager ttm WHERE ttm.task_id = tts.task_id) as managerString
		from tb_task_sub tts
		where task_super_id = #{taskSuperId} 
		and (tts.use_public = true or (tts.use_public = false and tts.member_no = #{memNo}))
		order by tts.sort_no

	]]>
	</select>
	<select id="selectMemberNo" parameterType="map" resultType="int">
	<![CDATA[
		select member_no from tb_member tm where user_id = #{userId} 
		and tm.project_id = #{pid}
	]]>
	</select>
	<insert id="insertNewLabel" parameterType="labelvo">
		<![CDATA[
			insert into tb_label
			( label_name, label_color, project_id )
			values
			( #{labelName}, #{labelColor}, #{projectId})
		]]>
	</insert>
	<select id="getLabelList" resultType="labelvo">
	<![CDATA[
		select *
		from tb_label tl
		where tl.project_id = #{pid}
	]]>
	</select>
	<select id="getMemberList" resultType="memberdto">
	<![CDATA[
		select tm.member_no , tm.user_id , tu.name, tu.rank, tm.pos_no, tu.img_code, tu.phone, tu.email, td.dept_name
		from tb_member tm, tb_user tu, tb_department td 
		where tm.project_id = #{pid}
			and tm.user_id = tu.id
			and	td.dept_code = tu.dept_code
	]]>
	</select>
	<select id="getTask" resultType="taskdto">
	<![CDATA[
		select tts.* , (SELECT json_agg(ttm.member_no) as manager_name FROM tb_task_manager ttm WHERE ttm.task_id = tts.task_id) as managerString
		from tb_task_sub tts 
		where tts.task_id =#{taskId}
	]]>
	</select>
	<select id="getFiles" resultType="filevo">
	<![CDATA[
		select *
		from tb_file tf 
		where tf.task_id =#{taskId}
	]]>
	</select>
	<update id="updateSortNo">
		<![CDATA[
			update tb_task_sub tts
			set sort_no = #{sortNo}, task_super_id = #{taskSuperId}
			where task_id = #{taskId}
		]]>
		
	</update>
	<update id="updateTaskSub">
		update tb_task_sub tts
		set title = #{title}, description = #{description}, use_public = #{usePublic}, start_date = #{startDate}, end_date =#{endDate}, state=#{state}
		<if test="!labels.equals('')">
		, labels=#{labels}
		</if>
		where task_id = #{taskId}
	</update>
</mapper>