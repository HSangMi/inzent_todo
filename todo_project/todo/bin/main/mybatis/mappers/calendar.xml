<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="calendar">
    <select id="getCalendarList" parameterType="String" resultType="scheduledto">
    <![CDATA[
        SELECT a.prjId, a.prjTitle, a.pTitle, a.cTitle, a.start_date, a.end_date, a.reg_date, a.state, a.use_public, b.manager_name
        FROM 
        (
        select tp.id prjId, tts.task_id cId, tp.title prjTitle, ttsp.title pTitle, tts.title cTitle, tts.start_date, tts.end_date, tts.reg_date, tts.state, tts.use_public
        from tb_task_sub tts, tb_task_super ttsp, tb_project tp
        where (tts.task_super_id = ttsp.task_id) and (ttsp.project_id = tp.id) 
        and (tts.task_id in (
                            select task_id 
                            from tb_task_manager 
                            where member_no in (select member_no from tb_member  where user_id=#{userId})
                            ))
        )
        AS a INNER join
        (
        select ttm.task_id cId , array_agg(tu."name") as manager_name
        from tb_task_manager ttm, tb_member tm,tb_user tu, tb_task_sub tts2 
        where ttm.task_id in (
        select ttm.task_id 
        from tb_task_manager ttm
        where ttm.member_no in (select member_no from tb_member where user_id=#{userId})
        )
        and ttm.task_id = tts2.task_id 
        and ttm.member_no = tm.member_no
        and tm.user_id = tu.id
        group by ttm.task_id
        )
        AS b
        ON a.cId = b.cId
        order by a.reg_date desc
    ]]>
    </select>
    <select id="getSuperTasks" parameterType="cpvo" resultType="cstdto">
    <![CDATA[
        select task_id pId, title pTitle
        from tb_task_super tts
        where project_id=#{cpvo.prjId} and member_no in (select member_no from tb_member  where user_id=#{cpvo.userId})
    ]]>
    </select>
</mapper>