<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dashboard">
    <select id="getTodaySuperList" parameterType="String" resultType="dashsuperdto">
        <![CDATA[
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp
        where  (ttsp.project_id = tp.id) 
        and  (current_date::varchar between ttsp.start_date and ttsp.end_date)
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in ( 
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public =true))
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp, tb_task_sub tts 
        where  (ttsp.project_id = tp.id) and (ttsp.task_id = tts.task_super_id )
        and   (current_date::varchar between tts.start_date and tts.end_date)
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public =true))
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp 
        where  (ttsp.project_id = tp.id) 
        and  (current_date::varchar between ttsp.start_date and ttsp.end_date)
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=true) 
                    and tts.use_public =false 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp, tb_task_sub tts
        where  (ttsp.project_id = tp.id) and (ttsp.task_id = tts.task_super_id )
        and   (current_date::varchar between tts.start_date and tts.end_date)
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=true) 
                    and tts.use_public =false 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp 
        where  (ttsp.project_id = tp.id) 
        and  (current_date::varchar between ttsp.start_date and ttsp.end_date)
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.i d from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=false) 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
        union 
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp , tb_task_sub tts
        where  (ttsp.project_id = tp.id) and (ttsp.task_id = tts.task_super_id )
        and  (current_date::varchar between tts.start_date and tts.end_date)
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=false) 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
    ]]>
    </select>
    <select id="getTodaySubList" parameterType="map" resultType="dashsubdto">
        <![CDATA[
        select tts.task_id cId, tts.title cTitle, tts.start_date, tts.end_date, tts.state, tts.use_public
        from tb_task_sub tts
        where (current_date::varchar between tts.start_date and tts.end_date)
        and tts.task_super_id=#{todaySub}
        and (tts.task_id in (
            select tts.task_id from tb_task_sub tts 
            where tts.task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId})))
            and tts.use_public = true))
        union
        select tts.task_id cId, tts.title cTitle, tts.start_date, tts.end_date, tts.state, tts.use_public
        from tb_task_sub tts 
        where (current_date::varchar between tts.start_date and tts.end_date)
        and tts.task_super_id=#{todaySub}
        and (tts.task_id in (
            select tts.task_id from tb_task_sub tts 
            where tts.task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId})))
            and tts.use_public = false and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})))
    ]]>
    </select>
    <select id="getWeekSuperList" parameterType="String" resultType="dashsuperdto">
        <![CDATA[
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp
        where  (ttsp.project_id = tp.id) 
        and  (((date_trunc('week',current_date)::date)::varchar between ttsp.start_date and ttsp.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between ttsp.start_date and ttsp.end_date))
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in ( 
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public =true))
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp, tb_task_sub tts 
        where  (ttsp.project_id = tp.id) and (ttsp.task_id = tts.task_super_id )
        and  (((date_trunc('week',current_date)::date)::varchar between tts.start_date and tts.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between tts.start_date and tts.end_date))
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public =true))
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp 
        where  (ttsp.project_id = tp.id) 
        and  (((date_trunc('week',current_date)::date)::varchar between ttsp.start_date and ttsp.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between ttsp.start_date and ttsp.end_date))
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=true) 
                    and tts.use_public =false 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
        union
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp, tb_task_sub tts
        where  (ttsp.project_id = tp.id) and (ttsp.task_id = tts.task_super_id )
        and  (((date_trunc('week',current_date)::date)::varchar between tts.start_date and tts.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between tts.start_date and tts.end_date))
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=true) 
                    and tts.use_public =false 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
        union 
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp 
        where  (ttsp.project_id = tp.id) 
        and  (((date_trunc('week',current_date)::date)::varchar between ttsp.start_date and ttsp.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between ttsp.start_date and ttsp.end_date))
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=false and tp.manager in (select member_no from tb_member tm where user_id=#{userId}) ) 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
        union 
        select ttsp.task_id pId, tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public, ttsp.progress_rate
        from  tb_task_super ttsp, tb_project tp , tb_task_sub tts
        where  (ttsp.project_id = tp.id) and (ttsp.task_id = tts.task_super_id )
        and  (((date_trunc('week',current_date)::date)::varchar between tts.start_date and tts.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between tts.start_date and tts.end_date))
        and (ttsp.task_id in (
                    select tts.task_id from tb_task_super tts
                    where tts.project_id in (
                        select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) and tp.use_public=false and tp.manager in (select member_no from tb_member tm where user_id=#{userId}) ) 
                    and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})
                    )
            )
    ]]>
    </select>
    <select id="getWeekSubList" parameterType="map" resultType="dashsubdto">
        <![CDATA[
        select tts.task_id cId, tts.title cTitle, tts.start_date, tts.end_date, tts.state, tts.use_public
        from tb_task_sub tts
        where (((date_trunc('week',current_date)::date)::varchar between tts.start_date and tts.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between tts.start_date and tts.end_date))
        and tts.task_super_id=#{weekSub}
        and (tts.task_id in (
            select tts.task_id from tb_task_sub tts 
            where tts.task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId})))
            and tts.use_public = true))
        union
        select tts.task_id cId, tts.title cTitle, tts.start_date, tts.end_date, tts.state, tts.use_public
        from tb_task_sub tts 
        where (((date_trunc('week',current_date)::date)::varchar between tts.start_date and tts.end_date) or ((date_trunc('week',current_date)::date+6)::varchar between tts.start_date and tts.end_date))
        and tts.task_super_id=#{weekSub}
        and (tts.task_id in (
            select tts.task_id from tb_task_sub tts 
            where tts.task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId})))
            and tts.use_public = false and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})))

    ]]>
    </select>
    <select id="getStarredList" parameterType="String" resultType="dashsuperdto">
        <![CDATA[
        select tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public
        from tb_starred_task tst, tb_task_super ttsp , tb_project tp
        where  (ttsp.project_id = tp.id ) and (tst.task_id = ttsp.task_id )
        and tst.task_id in (
                select tts.task_id from tb_task_super tts where tts.project_id in (
                select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public = true)
        union
        select tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public
            from tb_starred_task tst, tb_task_super ttsp , tb_project tp
            where  (ttsp.project_id = tp.id ) and (tst.task_id = ttsp.task_id )
            and tst.task_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public = false and tts.member_no in (select member_no from tb_member tm where user_id=#{userId}))
        union
        select tp.title prjTitle, tts2.title pTitle, tts2.start_date, tts2.end_date, tts2.reg_date, tts2.state, tts2.use_public
            from tb_starred_task tst, tb_task_sub tts2, tb_task_super ttsp , tb_project tp
            where  (ttsp.project_id = tp.id ) and (tst.task_id = tts2.task_id ) and (ttsp.task_id = tts2.task_super_id )
            and tst.task_id in (
                    select tts.task_id from tb_task_sub tts
                    where task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public = true) and tts.use_public = true)
        union 
        select tp.title prjTitle, tts2.title pTitle, tts2.start_date, tts2.end_date, tts2.reg_date, tts2.state, tts2.use_public
            from tb_starred_task tst, tb_task_sub tts2, tb_task_super ttsp , tb_project tp
            where  (ttsp.project_id = tp.id ) and (tst.task_id = tts2.task_id ) and (ttsp.task_id = tts2.task_super_id )
            and tst.task_id in (
                    select tts.task_id from tb_task_sub tts
                    where task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public = true) 
                    and tts.use_public = false) 
        union
        select tp.title prjTitle, tts2.title pTitle, tts2.start_date, tts2.end_date, tts2.reg_date, tts2.state, tts2.use_public
            from tb_starred_task tst, tb_task_sub tts2, tb_task_super ttsp , tb_project tp
            where  (ttsp.project_id = tp.id ) and (tst.task_id = tts2.task_id ) and (ttsp.task_id = tts2.task_super_id )
            and tst.task_id in (
                    select tts.task_id from tb_task_sub tts
                    where task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=true) and tts.use_public = false and tts.member_no in (select member_no from tb_member tm where user_id=#{userId})) 
                    and tts.use_public = false and tts.member_no in (select member_no from tb_member tm where user_id=#{userId}))
        union
        select tp.title prjTitle, ttsp.title pTitle, ttsp.start_date, ttsp.end_date, ttsp.reg_date, ttsp.state, ttsp.use_public
            from tb_starred_task tst, tb_task_super ttsp , tb_project tp
            where  (ttsp.project_id = tp.id ) and (tst.task_id = ttsp.task_id )
            and tst.task_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member  where user_id=#{userId}) and tp.use_public=false and tp.manager in (select member_no from tb_member tm where user_id=#{userId})))
        union 
        select tp.title prjTitle, tts2.title pTitle, tts2.start_date, tts2.end_date, tts2.reg_date, tts2.state, tts2.use_public
            from tb_starred_task tst, tb_task_sub tts2, tb_task_super ttsp , tb_project tp
            where  (ttsp.project_id = tp.id ) and (tst.task_id = tts2.task_id ) and (ttsp.task_id = tts2.task_super_id )
            and tst.task_id in (
                    select tts.task_id from tb_task_sub tts
                    where task_super_id in (
                    select tts.task_id from tb_task_super tts where tts.project_id in (
                    select tp.id from tb_project tp where tp.id in (select project_id from tb_member where user_id=#{userId}) 
                    and tp.use_public = false 
                    and tp.manager in (select member_no from tb_member tm where user_id=#{userId}))))  
    ]]>
    </select>
</mapper>